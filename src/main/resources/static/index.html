<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Quản lý Sinh Viên</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container mt-5">

    <h2 class="mb-4 text-center">Quản Lý Sinh Viên</h2>

    <div class="input-group mb-3">
        <input type="text" id="searchInput" class="form-control" placeholder="Nhập tên hoặc email để tìm...">
        <button class="" onclick="doSearch()">Tìm kiếm</button>
        <button class="" onclick="resetSearch()">Làm mới</button>
    </div>


    <div class="card p-4 mb-4">
        <div class="row g-3">
            <input type="hidden" id="studentId"> <div class="col-md-5">
                <input type="text" id="name" class="form-control" placeholder="Họ và tên">
            </div>
            <div class="col-md-5">
                <input type="email" id="email" class="form-control" placeholder="Email">
            </div>
            <div class="col-md-2">
                <button onclick="saveStudent()" class="btn btn-primary w-100">Lưu</button>
            </div>
        </div>
    </div>

    <table class="table table-bordered table-hover">
        <thead class="table-dark">
            <tr>
                <th>ID</th>
                <th>Tên</th>
                <th>Email</th>
                <th>Hành động</th>
            </tr>
        </thead>
        <tbody id="studentTableBody">
            </tbody>
    </table>

    <script>
        const API_URL = "https://students-management-production-1d35.up.railway.app/api/v1/students";

        // 1. Hàm load danh sách
        async function loadStudents() {
            try {
                const response = await fetch(API_URL);
                const result = await response.json(); // Nhận về ApiResponse
                
                const tableBody = document.getElementById("studentTableBody");
                tableBody.innerHTML = "";

                if (result.status === "success") {
                    result.data.forEach(student => {
                        const row = `
                            <tr>
                                <td>${student.id}</td>
                                <td>${student.name}</td>
                                <td>${student.email}</td>
                                <td>
                                    <button class= btn-sm" onclick="editStudent(${student.id})">Sửa</button>
                                    <button class="btn-sm" onclick="deleteStudent(${student.id})">Xóa</button>
                                </td>
                            </tr>
                        `;
                        tableBody.innerHTML += row;
                    });
                }
            } catch (error) {
                console.error("Lỗi:", error);
            }
        }

        // 2. Hàm Lưu (Tạo mới hoặc Cập nhật)
        async function saveStudent() {
            const idValue = document.getElementById("studentId").value;
            const name = document.getElementById("name").value;
            const email = document.getElementById("email").value;
        
            if (!name || !email) {
                alert("Vui lòng nhập đầy đủ thông tin!");
                return;
            }
        
            // Tạo object dữ liệu sạch
            const studentData = {
                name: name.trim(),
                email: email.trim()
            };
        
            // Chỉ thêm ID vào body nếu đang ở chế độ SỬA (id có giá trị)
            if (idValue) {
                studentData.id = parseInt(idValue);
            }
        
            const method = idValue ? "PUT" : "POST";
            const url = idValue ? `${API_URL}/${idValue}` : API_URL;
        
            try {
                const response = await fetch(url, {
                    method: method,
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(studentData) 
                });
        
                const result = await response.json();
                if (response.ok && result.status === "success") {
                    alert(result.message);
                    // Reset form hoàn toàn
                    document.getElementById("studentId").value = ""; 
                    document.getElementById("name").value = "";
                    document.getElementById("email").value = "";
                    loadStudents(); 
                } else {
                    alert("Lỗi: " + (result.message || "Không thể lưu dữ liệu"));
                }
            } catch (error) {
                console.error("Lỗi kết nối:", error);
                alert("Lỗi kết nối server!");
            }
        }

        // 3. Hàm Xóa
        async function deleteStudent(id) {
            if(confirm("Bạn có chắc muốn xóa?")) {
                const response = await fetch(`${API_URL}/${id}`, {
                    method: "DELETE"
                });
                const result = await response.json();
                if(result.status === "success") {
                    loadStudents();
                } else {
                    alert("Lỗi xóa");
                }
            }
        }

        // 4. Hàm điền dữ liệu lên form để sửa
        async function editStudent(id) {
            // Gọi API lấy chi tiết sinh viên để đảm bảo dữ liệu mới nhất
            const response = await fetch(`${API_URL}/${id}`);
            const result = await response.json();
            
            if(result.status === "success") {
                const s = result.data;
                document.getElementById("studentId").value = s.id;
                document.getElementById("name").value = s.name;
                document.getElementById("email").value = s.email;
            }
        }
        // 5. Hàm Tìm kiếm
        async function doSearch() {
            const keyword = document.getElementById("searchInput").value;
            
            const response = await fetch(`${API_URL}/search?keyword=${keyword}`);
            const result = await response.json();

            const tableBody = document.getElementById("studentTableBody");
            tableBody.innerHTML = "";

            if (result.status === "success" && result.data.length > 0) {
                result.data.forEach(student => {
                    const row = `
                        <tr>
                            <td>${student.id}</td>
                            <td>${student.name}</td>
                            <td>${student.email}</td>
                            <td>
                                <button class="btn-sm " onclick="editStudent(${student.id})">Sửa</button>
                                <button class="btn-sm" onclick="deleteStudent(${student.id})">Xóa</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });
            } else {
                tableBody.innerHTML = '<tr><td colspan="4" class="text-center">Không tìm thấy kết quả nào</td></tr>';
            }
        }

        function resetSearch() {
            document.getElementById("searchInput").value = "";
            loadStudents(); 
        }

        // Chạy khi trang vừa load
        loadStudents();
    </script>
</body>
</html>
